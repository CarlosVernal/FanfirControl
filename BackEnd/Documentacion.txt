# Documentaci√≥n Backend - FafnirControl

## üìã Descripci√≥n General

FafnirControl es un backend para una aplicaci√≥n de finanzas personales desarrollada con Node.js, Express y MongoDB. Permite a los usuarios gestionar sus ingresos, gastos, presupuestos, categor√≠as y metas de ahorro de manera organizada y segura.

## üèóÔ∏è Arquitectura

### Stack Tecnol√≥gico
- **Node.js** + **Express**: Servidor backend (usando ES Modules)
- **MongoDB** con **Mongoose**: Base de datos y ODM
- **JWT**: Autenticaci√≥n y autorizaci√≥n
- **bcryptjs**: Cifrado de contrase√±as
- **CORS**: Pol√≠ticas de origen cruzado
- **dotenv**: Variables de entorno

### Estructura del Proyecto
```
BackEnd/
‚îú‚îÄ‚îÄ controllers/        # L√≥gica de negocio (ES Modules)
‚îÇ   ‚îú‚îÄ‚îÄ authController.js
‚îÇ   ‚îú‚îÄ‚îÄ budgetsController.js
‚îÇ   ‚îú‚îÄ‚îÄ CategoryController.js
‚îÇ   ‚îú‚îÄ‚îÄ mountReportConroler.js
‚îÇ   ‚îú‚îÄ‚îÄ savingGoalController.js
‚îÇ   ‚îú‚îÄ‚îÄ transactionController.js
‚îÇ   ‚îî‚îÄ‚îÄ usersController.js
‚îú‚îÄ‚îÄ middleware/         # Middlewares personalizados (ES Modules)
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js
‚îÇ   ‚îú‚îÄ‚îÄ tokenExtractor.js
‚îÇ   ‚îî‚îÄ‚îÄ ValidationErrorHandle.js
‚îú‚îÄ‚îÄ models/            # Esquemas de MongoDB (ES Modules)
‚îÇ   ‚îú‚îÄ‚îÄ Budget.js
‚îÇ   ‚îú‚îÄ‚îÄ Category.js
‚îÇ   ‚îú‚îÄ‚îÄ MountsReport.js
‚îÇ   ‚îú‚îÄ‚îÄ SavingGoal.js
‚îÇ   ‚îú‚îÄ‚îÄ Transaction.js
‚îÇ   ‚îî‚îÄ‚îÄ User.js
‚îú‚îÄ‚îÄ routes/            # Definici√≥n de rutas (ES Modules)
‚îÇ   ‚îú‚îÄ‚îÄ auth.js
‚îÇ   ‚îú‚îÄ‚îÄ budgets.js
‚îÇ   ‚îú‚îÄ‚îÄ categorys.js
‚îÇ   ‚îú‚îÄ‚îÄ mountReports.js
‚îÇ   ‚îú‚îÄ‚îÄ transactions.js
‚îÇ   ‚îî‚îÄ‚îÄ users.js
‚îú‚îÄ‚îÄ validators/        # Validaciones con express-validator (ES Modules)
‚îÇ   ‚îú‚îÄ‚îÄ authValidations.js
‚îÇ   ‚îú‚îÄ‚îÄ budgetValidations.js
‚îÇ   ‚îú‚îÄ‚îÄ categoryValidations.js
‚îÇ   ‚îú‚îÄ‚îÄ commons.js
‚îÇ   ‚îú‚îÄ‚îÄ transactionValidations.js
‚îÇ   ‚îî‚îÄ‚îÄ userValidations.js
‚îú‚îÄ‚îÄ utils/             # Utilidades (ES Modules)
‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îî‚îÄ‚îÄ mongo.js
‚îú‚îÄ‚îÄ app.js             # Configuraci√≥n de Express (ES Modules)
‚îú‚îÄ‚îÄ index.js           # Punto de entrada (ES Modules)
‚îú‚îÄ‚îÄ package.json       # Debe incluir "type": "module"
‚îî‚îÄ‚îÄ .env               # Variables de entorno
```

## üîß Configuraci√≥n ES Modules

### package.json
Asegurar que incluya:
```json
{
  "type": "module",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
    "test": "NODE_OPTIONS=--experimental-vm-modules jest"
  }
}
```

### Sintaxis de Importaci√≥n/Exportaci√≥n
- **Importaciones**: `import Module from './path/module.js'`
- **Exportaciones nombradas**: `export function functionName() {}`
- **Exportaciones por defecto**: `export default variableName`
- **Extensiones**: Todas las rutas deben incluir `.js`

## üîê Autenticaci√≥n y Seguridad

### Sistema de Autenticaci√≥n
- **JWT Tokens**: Tokens con expiraci√≥n de 1 hora
- **bcryptjs**: Cifrado de contrase√±as con salt rounds
- **Middleware tokenExtractor**: Protege rutas sensibles
- **Verificaci√≥n de email**: Sistema de tokens para confirmar cuentas
- **Recuperaci√≥n de contrase√±a**: Tokens temporales para reset

### Sistema de Validaciones
- **express-validator**: Validaci√≥n robusta de inputs
- **ValidationErrorHandle**: Middleware centralizado para manejo de errores de validaci√≥n
- **Validaciones por recurso**: Archivos espec√≠ficos por controlador
- **Patrones reutilizables**: commons.js con validaciones compartidas

### Variables de Entorno
```env
MONGODB_URI=mongodb+srv://...
TEST_MONGODB_URI=mongodb+srv://...
PORT=4000
NODE_ENV=development
SECRET=tu_clave_secreta_jwt
```

## üìä Modelos de Datos

### User (Usuario)
- email, passwordHash, name, roles
- isVerified, verificationToken
- resetPasswordToken, resetPasswordExpires

### Category (Categor√≠as)
- Sistema de categor√≠as padre-hijo (m√°ximo 1 nivel)
- userId, name, parentCategoryId

### Transaction (Transacciones)
- Ingresos y gastos con amount (+/-)
- Soporte para cuotas (installments) y cuotas pagadas (installmentsPaid)
- Categor√≠as por transacci√≥n con validaci√≥n de pertenencia
- Transacciones recurrentes (monthly, yearly)
- Paginaci√≥n, filtros avanzados y ordenamiento
- B√∫squeda por rango de fechas, montos, categor√≠as y tipo

### Budget (Presupuestos)
- Presupuestos mensuales por usuario
- Sistema de activaci√≥n/desactivaci√≥n
- expectedIncome, expectedExpense

### SavingGoal (Metas de Ahorro)
- targetAmount, currentSavedAmount
- fechas de inicio y objetivo

### MountsReport (Reportes)
- Reportes mensuales de ingresos/gastos
- Asociados a presupuestos activos

## üõ†Ô∏è APIs Principales

### Autenticaci√≥n (/api)
- `POST /login` - Inicio de sesi√≥n
- `POST /register` - Registro de usuario
- `POST /verify-email` - Verificaci√≥n de email
- `POST /forgot-password` - Solicitar reset
- `POST /reset-password` - Restablecer contrase√±a

### Usuarios (/api/users)
- CRUD completo para gesti√≥n de usuarios

### Categor√≠as (/api/category)
- Gesti√≥n de categor√≠as padre-hijo
- Filtros por usuario y categor√≠a padre

### Transacciones (/api/transactions)
- CRUD completo con validaciones robustas
- Filtros avanzados: fechas, montos, categor√≠as, tipo (ingreso/gasto)
- Paginaci√≥n con metadatos completos
- Ordenamiento configurable (fecha, monto, descripci√≥n)
- Soporte para cuotas y transacciones recurrentes
- B√∫squeda jer√°rquica (categor√≠as padre incluyen hijas)

### Presupuestos (/api/budgets)
- Sistema de versionado (crear nuevo = desactivar anterior)
- Activaci√≥n de presupuestos antiguos

### Reportes (/api/mounts)
- Reportes con m√°rgenes positivos/negativos
- Filtros por fecha, usuario y margen

## ‚ö†Ô∏è Problemas Identificados y Estado

### ‚úÖ Errores Cr√≠ticos Resueltos
1. **authController.js**: Convertido a ES Modules ‚úÖ
2. **budgetsController.js**: Convertido a ES Modules ‚úÖ
3. **CategoryController.js**: Convertido a ES Modules ‚úÖ
4. **transactionController.js**: Mejorado con validaciones y funcionalidades avanzadas ‚úÖ
5. **tokenExtractor.js**: Convertido a ES Modules ‚úÖ
6. **errorHandler.js**: Convertido a ES Modules ‚úÖ
7. **Sistema de validaciones**: Implementado con express-validator ‚úÖ
8. **Middleware de validaci√≥n**: ValidationErrorHandle.js implementado ‚úÖ

### üîß Mejoras Recomendadas

#### Generales
- [ ] Imagen de usuario
- [ ] Completar conversi√≥n de todos los archivos restantes a ES Modules

#### Seguridad
- [‚úÖ] Implementar rate limiting
- [‚úÖ] Validar todos los inputs con express-validator
- [‚úÖ] Middleware centralizado para errores de validaci√≥n
- [ ] Agregar helmet para headers de seguridad
- [ ] Implementar CSRF protection

#### Validaciones
- [‚úÖ] Validar ObjectIds de MongoDB
- [‚úÖ] Verificar permisos de usuario en todas las operaciones
- [‚úÖ] Validar rangos de fechas y montos
- [‚úÖ] Validaciones de relaciones (categor√≠as, cuotas)
- [ ] Validaciones para categor√≠as y reportes (pendientes)

#### Optimizaci√≥n
- [ ] Agregar indices en MongoDB
- [‚úÖ] Implementar paginaci√≥n en listados
- [‚úÖ] Filtros avanzados y ordenamiento
- [ ] Cache para consultas frecuentes
- [ ] Compresi√≥n de respuestas

#### C√≥digo
- [‚úÖ] Conversi√≥n a ES Modules
- [‚úÖ] Estandarizar nombres (mountReportConroler ‚Üí mountReportController)
- [‚úÖ] Sistema de validaciones con express-validator
- [‚úÖ] Middleware centralizado para manejo de errores
- [‚úÖ] Funcionalidades avanzadas en transactionController
- [ ] Agregar JSDoc para documentaci√≥n
- [ ] Implementar logging estructurado
- [ ] Tests unitarios e integraci√≥n

#### Base de Datos
- [‚úÖ] Agregar campo `margin` calculado en MountsReport
- [ ] Implementar cascading delete para categor√≠as
- [ ] Optimizar queries con populate selectivo

### üß™ Testing con ES Modules
```json
{
  "scripts": {
    "test": "NODE_OPTIONS=--experimental-vm-modules jest"
  },
  "jest": {
    "extensionsToTreatAsEsm": [".js"],
    "globals": {
      "ts-jest": {
        "useESM": true
      }
    }
  }
}
```

### üì¶ Dependencias para ES Modules
```bash
npm install helmet express-rate-limit express-validator
npm install --save-dev jest supertest mongodb-memory-server
```

## üéØ Patrones de Desarrollo

### Estructura de Rutas
```javascript
// Patr√≥n est√°ndar para todas las rutas
import express from "express";
import * as controller from "../controllers/resourceController.js";
import * as validators from "../validators/resourceValidations.js";
import tokenExtractor from "../middleware/tokenExtractor.js";
import { handleValidationErrors } from "../middleware/ValidationErrorHandle.js";

const router = express.Router();

// Middleware de autenticaci√≥n (rutas protegidas)
router.use(tokenExtractor);

// Patr√≥n: validaci√≥n + manejo de errores + controller
router.post("/", validators.createValidation, handleValidationErrors, controller.create);
router.get("/", validators.getValidation, handleValidationErrors, controller.getAll);
router.get("/:id", validators.getByIdValidation, handleValidationErrors, controller.getById);
router.put("/:id", validators.updateValidation, handleValidationErrors, controller.update);
router.delete("/:id", validators.deleteValidation, handleValidationErrors, controller.delete);

export default router;
```

### Validaciones con express-validator
```javascript
// commons.js - Validaciones reutilizables
export const emailCheck = body('email')
    .isEmail().withMessage('El email no es v√°lido').normalizeEmail()

export const mongoIdCheck = param('id')
    .exists().withMessage('El ID es obligatorio')
    .isMongoId().withMessage('El ID debe ser un ObjectId v√°lido')

// resourceValidations.js - Validaciones espec√≠ficas
export const createResourceValidation = [
    body("name").isString().isLength({ min: 3, max: 100 }),
    body("amount").isNumeric().custom((value) => value !== 0)
];
```
```json
{
  "type": "module",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
    "test": "NODE_OPTIONS=--experimental-vm-modules jest"
  }
}
```

## üìù Notas sobre ES Modules
- Todas las rutas de importaci√≥n deben incluir la extensi√≥n `.js`
- `__dirname` y `__filename` no est√°n disponibles, usar `import.meta.url`
- Los tests requieren configuraci√≥n especial para ES Modules
- Compatibilidad con herramientas como nodemon y jest

## üìù Notas Adicionales
- El proyecto est√° configurado para m√∫ltiples entornos (dev/test/prod)
- Base de datos: FanfirDatabase (dev/prod), test (testing)
- Arquitectura modular y escalable
- Preparado para integraci√≥n con frontend React
- **Migrado completamente a ES Modules**

---
**√öltima actualizaci√≥n**: Agosto 2025
**Versi√≥n**: 1.2.0 (ES Modules + Validaciones Completas)
