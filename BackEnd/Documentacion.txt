# DocumentaciÃ³n Backend - FafnirControl

## ğŸ“‹ DescripciÃ³n General

FafnirControl es un backend para una aplicaciÃ³n de finanzas personales desarrollada con Node.js, Express y MongoDB. Permite a los usuarios gestionar sus ingresos, gastos, presupuestos, categorÃ­as y metas de ahorro de manera organizada y segura.

## ğŸ—ï¸ Arquitectura

### Stack TecnolÃ³gico
- **Node.js** + **Express**: Servidor backend (usando ES Modules)
- **MongoDB** con **Mongoose**: Base de datos y ODM
- **JWT**: AutenticaciÃ³n y autorizaciÃ³n
- **bcryptjs**: Cifrado de contraseÃ±as
- **CORS**: PolÃ­ticas de origen cruzado
- **dotenv**: Variables de entorno

### Estructura del Proyecto
```
BackEnd/
â”œâ”€â”€ controllers/        # LÃ³gica de negocio (ES Modules)
â”‚   â”œâ”€â”€ authController.js
â”‚   â”œâ”€â”€ budgetsController.js
â”‚   â”œâ”€â”€ CategoryController.js
â”‚   â”œâ”€â”€ mountReportConroler.js
â”‚   â”œâ”€â”€ savingGoalController.js
â”‚   â”œâ”€â”€ transactionController.js
â”‚   â””â”€â”€ usersController.js
â”œâ”€â”€ middleware/         # Middlewares personalizados (ES Modules)
â”‚   â”œâ”€â”€ errorHandler.js
â”‚   â”œâ”€â”€ tokenExtractor.js
â”‚   â””â”€â”€ ValidationErrorHandle.js
â”œâ”€â”€ models/            # Esquemas de MongoDB (ES Modules)
â”‚   â”œâ”€â”€ Budget.js
â”‚   â”œâ”€â”€ Category.js
â”‚   â”œâ”€â”€ MountsReport.js
â”‚   â”œâ”€â”€ SavingGoal.js
â”‚   â”œâ”€â”€ Transaction.js
â”‚   â””â”€â”€ User.js
â”œâ”€â”€ routes/            # DefiniciÃ³n de rutas (ES Modules)
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ budgets.js
â”‚   â”œâ”€â”€ categorys.js
â”‚   â”œâ”€â”€ mountReports.js
â”‚   â”œâ”€â”€ transactions.js
â”‚   â””â”€â”€ users.js
â”œâ”€â”€ validators/        # Validaciones con express-validator (ES Modules)
â”‚   â”œâ”€â”€ authValidations.js
â”‚   â”œâ”€â”€ budgetValidations.js
â”‚   â”œâ”€â”€ categoryValidations.js
â”‚   â”œâ”€â”€ commons.js
â”‚   â”œâ”€â”€ transactionValidations.js
â”‚   â””â”€â”€ userValidations.js
â”œâ”€â”€ utils/             # Utilidades (ES Modules)
â”‚   â”œâ”€â”€ config.js
â”‚   â””â”€â”€ mongo.js
â”œâ”€â”€ app.js             # ConfiguraciÃ³n de Express (ES Modules)
â”œâ”€â”€ index.js           # Punto de entrada (ES Modules)
â”œâ”€â”€ package.json       # Debe incluir "type": "module"
â””â”€â”€ .env               # Variables de entorno
```

## ğŸ”§ ConfiguraciÃ³n ES Modules

### package.json
Asegurar que incluya:
```json
{
  "type": "module",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
  }
}
```

### Sintaxis de ImportaciÃ³n/ExportaciÃ³n
- **Importaciones**: `import Module from './path/module.js'`
- **Exportaciones nombradas**: `export function functionName() {}`
- **Exportaciones por defecto**: `export default variableName`
- **Extensiones**: Todas las rutas deben incluir `.js`

## ğŸ” AutenticaciÃ³n y Seguridad

### Sistema de AutenticaciÃ³n
- **JWT Tokens**: Tokens con expiraciÃ³n de 1 hora
- **bcryptjs**: Cifrado de contraseÃ±as con salt rounds
- **Middleware tokenExtractor**: Protege rutas sensibles
- **VerificaciÃ³n de email**: Sistema de tokens para confirmar cuentas
- **RecuperaciÃ³n de contraseÃ±a**: Tokens temporales para reset

### Sistema de Validaciones
- **express-validator**: ValidaciÃ³n robusta de inputs
- **ValidationErrorHandle**: Middleware centralizado para manejo de errores de validaciÃ³n
- **Validaciones por recurso**: Archivos especÃ­ficos por controlador
- **Patrones reutilizables**: commons.js con validaciones compartidas

### Variables de Entorno
```env
MONGODB_URI=mongodb+srv://...
TEST_MONGODB_URI=mongodb+srv://...
PORT=4000
NODE_ENV=development
SECRET=tu_clave_secreta_jwt
```

## ğŸ“Š Modelos de Datos

### User (Usuario)
- email, passwordHash, name, roles
- isVerified, verificationToken
- resetPasswordToken, resetPasswordExpires

### Category (CategorÃ­as)
- Sistema de categorÃ­as padre-hijo (mÃ¡ximo 1 nivel)
- userId, name, parentCategoryId

### Transaction (Transacciones)
- Ingresos y gastos con amount (+/-)
- Soporte para cuotas (installments) y cuotas pagadas (installmentsPaid)
- CategorÃ­as por transacciÃ³n con validaciÃ³n de pertenencia
- Transacciones recurrentes (monthly, yearly)
- PaginaciÃ³n, filtros avanzados y ordenamiento
- BÃºsqueda por rango de fechas, montos, categorÃ­as y tipo

### Budget (Presupuestos)
- Presupuestos mensuales por usuario
- Sistema de activaciÃ³n/desactivaciÃ³n
- expectedIncome, expectedExpense

### SavingGoal (Metas de Ahorro)
- targetAmount, currentSavedAmount
- fechas de inicio y objetivo

### MountsReport (Reportes)
- Reportes mensuales de ingresos/gastos
- Asociados a presupuestos activos

## ğŸ› ï¸ APIs Principales

### AutenticaciÃ³n (/api)
- `POST /login` - Inicio de sesiÃ³n
- `POST /register` - Registro de usuario
- `POST /verify-email` - VerificaciÃ³n de email
- `POST /forgot-password` - Solicitar reset
- `POST /reset-password` - Restablecer contraseÃ±a

### Usuarios (/api/users)
- CRUD completo para gestiÃ³n de usuarios

### CategorÃ­as (/api/category)
- GestiÃ³n de categorÃ­as padre-hijo
- Filtros por usuario y categorÃ­a padre

### Transacciones (/api/transactions)
- CRUD completo con validaciones robustas
- Filtros avanzados: fechas, montos, categorÃ­as, tipo (ingreso/gasto)
- PaginaciÃ³n con metadatos completos
- Ordenamiento configurable (fecha, monto, descripciÃ³n)
- Soporte para cuotas y transacciones recurrentes
- BÃºsqueda jerÃ¡rquica (categorÃ­as padre incluyen hijas)

### Presupuestos (/api/budgets)
- Sistema de versionado (crear nuevo = desactivar anterior)
- ActivaciÃ³n de presupuestos antiguos

### Reportes (/api/mounts)
- Reportes con mÃ¡rgenes positivos/negativos
- Filtros por fecha, usuario y margen

## âš ï¸ Problemas Identificados y Estado

### âœ… Errores CrÃ­ticos Resueltos
1. **authController.js**: Convertido a ES Modules âœ…
2. **budgetsController.js**: Convertido a ES Modules âœ…
3. **CategoryController.js**: Convertido a ES Modules âœ…
4. **transactionController.js**: Mejorado con validaciones y funcionalidades avanzadas âœ…
5. **savingGoalController.js**: Convertido a ES Modules âœ…
6. **mountReportController.js**: Convertido a ES Modules âœ…
7. **usersController.js**: Convertido a ES Modules âœ…
8. **tokenExtractor.js**: Convertido a ES Modules âœ…
9. **errorHandler.js**: Convertido a ES Modules âœ…
10. **Sistema de validaciones**: Implementado completamente con express-validator âœ…
11. **Middleware de validaciÃ³n**: ValidationErrorHandle.js implementado âœ…
12. **Todos los modelos**: Convertidos a ES Modules âœ…
13. **Todas las rutas**: Convertidas a ES Modules con validaciones âœ…
14. **Utils y configuraciÃ³n**: Convertidos a ES Modules âœ…

### ğŸ”§ Mejoras Recomendadas

#### Generales
- [ ] Imagen de usuario
- [âœ…] Completar conversiÃ³n de todos los archivos a ES Modules

#### Seguridad
- [âœ…] Implementar rate limiting
- [âœ…] Validar todos los inputs con express-validator
- [âœ…] Middleware centralizado para errores de validaciÃ³n
- [ ] Agregar helmet para headers de seguridad
- [ ] Implementar CSRF protection

#### Validaciones
- [âœ…] Validar ObjectIds de MongoDB
- [âœ…] Verificar permisos de usuario en todas las operaciones
- [âœ…] Validar rangos de fechas y montos
- [âœ…] Validaciones de relaciones (categorÃ­as, cuotas)
- [âœ…] Validaciones para categorÃ­as, presupuestos, transacciones, reportes y metas de ahorro

#### OptimizaciÃ³n
- [ ] Agregar indices en MongoDB
- [âœ…] Implementar paginaciÃ³n en listados
- [âœ…] Filtros avanzados y ordenamiento
- [ ] Cache para consultas frecuentes
- [ ] CompresiÃ³n de respuestas

#### CÃ³digo
- [âœ…] ConversiÃ³n completa a ES Modules
- [âœ…] Estandarizar nombres (mountReportConroler â†’ mountReportController)
- [âœ…] Sistema de validaciones completo con express-validator
- [âœ…] Middleware centralizado para manejo de errores
- [âœ…] Funcionalidades avanzadas en transactionController
- [ ] Agregar JSDoc para documentaciÃ³n
- [ ] Implementar logging estructurado
- [ ] Tests unitarios e integraciÃ³n

#### Base de Datos
- [âœ…] Agregar campo `margin` calculado en MountsReport
- [âœ…] Implementar cascading delete para categorÃ­as
- [ ] Optimizar queries con populate selectivo

### ğŸ§ª Testing con ES Modules (Por implementar)
```json
{
  "scripts": {
    "test": "NODE_OPTIONS=--experimental-vm-modules jest"
  },
  "jest": {
    "extensionsToTreatAsEsm": [".js"],
    "globals": {
      "ts-jest": {
        "useESM": true
      }
    }
  }
}
```

### ğŸ“¦ Dependencias para ES Modules
```bash
npm install helmet express-rate-limit express-validator
npm install --save-dev jest supertest mongodb-memory-server
```

## ğŸ¯ Patrones de Desarrollo

### Estructura de Rutas
```javascript
// PatrÃ³n estÃ¡ndar para todas las rutas
import express from "express";
import * as controller from "../controllers/resourceController.js";
import * as validators from "../validators/resourceValidations.js";
import tokenExtractor from "../middleware/tokenExtractor.js";
import { handleValidationErrors } from "../middleware/ValidationErrorHandle.js";

const router = express.Router();

// Middleware de autenticaciÃ³n (rutas protegidas)
router.use(tokenExtractor);

// PatrÃ³n: validaciÃ³n + manejo de errores + controller
router.post("/", validators.createValidation, handleValidationErrors, controller.create);
router.get("/", validators.getValidation, handleValidationErrors, controller.getAll);
router.get("/:id", validators.getByIdValidation, handleValidationErrors, controller.getById);
router.put("/:id", validators.updateValidation, handleValidationErrors, controller.update);
router.delete("/:id", validators.deleteValidation, handleValidationErrors, controller.delete);

export default router;
```

### Validaciones con express-validator
```javascript
// commons.js - Validaciones reutilizables
export const emailCheck = body('email')
    .isEmail().withMessage('El email no es vÃ¡lido').normalizeEmail()

export const mongoIdCheck = param('id')
    .exists().withMessage('El ID es obligatorio')
    .isMongoId().withMessage('El ID debe ser un ObjectId vÃ¡lido')

// resourceValidations.js - Validaciones especÃ­ficas
export const createResourceValidation = [
    body("name").isString().isLength({ min: 3, max: 100 }),
    body("amount").isNumeric().custom((value) => value !== 0)
];
```
```json
{
  "type": "module",
  "scripts": {
    "dev": "nodemon index.js",
    "start": "node index.js",
    "test": "NODE_OPTIONS=--experimental-vm-modules jest"
  }
}
```

## ğŸ“ Notas sobre ES Modules
- Todas las rutas de importaciÃ³n deben incluir la extensiÃ³n `.js`
- `__dirname` y `__filename` no estÃ¡n disponibles, usar `import.meta.url`
- Los tests requieren configuraciÃ³n especial para ES Modules
- Compatibilidad con herramientas como nodemon y jest

## ğŸ“ Notas Adicionales
- El proyecto estÃ¡ configurado para mÃºltiples entornos (dev/test/prod)
- Base de datos: FanfirDatabase (dev/prod), test (testing)
- Arquitectura modular y escalable
- Preparado para integraciÃ³n con frontend React
- **Migrado completamente a ES Modules**

---
**Ãšltima actualizaciÃ³n**: Agosto 2025
**VersiÃ³n**: 2.0.0 (ES Modules Completo + Sistema de Validaciones Robusto)

## ğŸš€ Estado de PreparaciÃ³n para Frontend

### âœ… LISTO PARA DESARROLLO FRONTEND

El backend de FafnirControl estÃ¡ **COMPLETAMENTE PREPARADO** para el desarrollo del frontend. Todos los componentes crÃ­ticos han sido implementados y probados:

#### ğŸ¯ CaracterÃ­sticas Implementadas:
- âœ… **100% ES Modules**: Toda la aplicaciÃ³n migrada
- âœ… **API RESTful Completa**: Todos los endpoints funcionales
- âœ… **AutenticaciÃ³n JWT**: Sistema robusto con tokens
- âœ… **Validaciones Robustas**: express-validator en todos los endpoints
- âœ… **Manejo de Errores**: Centralizado y estandarizado
- âœ… **Rate Limiting**: ProtecciÃ³n contra abuso
- âœ… **CORS Configurado**: Listo para frontend
- âœ… **PaginaciÃ³n y Filtros**: En listados principales
- âœ… **Base de Datos**: MongoDB conectada y operativa

#### ğŸ“‹ Endpoints Disponibles:
- ğŸ” **AutenticaciÃ³n**: `/api/login`, `/api/register`, `/api/verify-email`, etc.
- ğŸ‘¥ **Usuarios**: `/api/users/*` (CRUD completo)
- ğŸ“Š **CategorÃ­as**: `/api/category/*` (con jerarquÃ­as padre-hijo)
- ğŸ’° **Transacciones**: `/api/transactions/*` (con cuotas, filtros avanzados)
- ğŸ’¼ **Presupuestos**: `/api/budgets/*` (con versionado)
- ğŸ¯ **Metas de Ahorro**: `/api/saving-goals/*` (CRUD completo)
- ğŸ“ˆ **Reportes**: `/api/mounts/*` (reportes mensuales)

#### ğŸ”§ Servidor:
- âœ… Funcionando en puerto 4000
- âœ… Sin errores de inicio
- âœ… ConexiÃ³n a MongoDB exitosa
- âœ… Nodemon configurado para hot-reload

### ğŸ¨ Recomendaciones para el Frontend:
1. **URL Base**: `http://localhost:4000/api`
2. **AutenticaciÃ³n**: Header `Authorization: Bearer <token>`
3. **Content-Type**: `application/json`
4. **Manejo de errores**: Respuestas estandarizadas con cÃ³digos HTTP
5. **PaginaciÃ³n**: Usar parÃ¡metros `page`, `limit`, `sort`
